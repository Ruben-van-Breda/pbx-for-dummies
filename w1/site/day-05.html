<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Week 1 ‚Äî Day 5: Inside a PBX ‚Äî Call Routing & Logic</title>
  <link rel="stylesheet" href="./site.css" />
</head>
<body>
  <main class="lesson">
    <header>
      <nav class="nav-top">
        <a href="./day-04.html">‚Üê Previous</a>
        <a href="./index.html">Back to Week 1</a>
        <a href="./day-06.html">Next ‚Üí</a>
      </nav>
      <h1>Day 5 ‚Äî Inside a PBX: Call Routing & Logic</h1>
    </header>
    <section class="content">
      <h2>Objectives</h2>
      <ul>
        <li>Understand dialplans and call context</li>
        <li>Learn how a PBX bridges two SIP dialogs</li>
      </ul>

      <h2>Key Concepts (Explained)</h2>
      <ul>
        <li><strong>Registrar</strong>: Service that accepts REGISTER from endpoints and maintains bindings (user ‚Üí Contact URI).</li>
        <li><strong>B2BUA (Back-to-Back User Agent)</strong>: PBX acts as both user agents, creating two separate call legs and bridging them.</li>
        <li><strong>Dialplan</strong>: Rule set determining how calls are routed based on called number (extension), caller, time, etc.</li>
      </ul>

      <h2>Example (Asterisk flavor)</h2>
      <pre><code>[internal]
exten => 1000,1,Dial(PJSIP/1000)
exten => 1001,1,Dial(PJSIP/1001)

[outbound]
exten => _9X.,1,Set(NUM=${EXTEN:1})
exten => _9X.,n,Dial(PJSIP/trunk/${NUM})</code></pre>

      <h2>Bridge Concept</h2>
      <ul>
        <li>Leg A: Caller ‚Üî PBX</li>
        <li>Leg B: PBX ‚Üî Callee (internal or external)</li>
        <li>PBX controls features (recording, IVR, transfer) between legs</li>
      </ul>

      <h2>Hands-on (15‚Äì20 min)</h2>
      <ol>
        <li>Open a sample <code>extensions.conf</code> and identify contexts</li>
        <li>Write a simple rule: internal calls 1xxx route to users; 9+number goes to trunk</li>
        <li>Note: Add safeguards (e.g., block international unless whitelisted)</li>
      </ol>

      <h2>Quick Check (Self-test)</h2>
      <ul>
        <li>What does a registrar store?</li>
        <li>Why is PBX called a B2BUA?</li>
        <li>What‚Äôs the meaning of <code>_9X.</code> in Asterisk pattern matching?</li>
      </ul>

      <h2>üìö Further Reading & References</h2>
      <ul>
        <li><a href="https://wiki.asterisk.org/wiki/display/AST/Dialplan" target="_blank" rel="noopener noreferrer">Asterisk Dialplan</a>: Official docs for dialplan concepts, priorities, and contexts.</li>
        <li><a href="https://wiki.asterisk.org/wiki/display/AST/Pattern+Matching" target="_blank" rel="noopener noreferrer">Asterisk Pattern Matching</a>: How <code>_X</code>, <code>.</code> and character classes work in extensions.</li>
        <li><a href="https://wiki.asterisk.org/wiki/display/AST/Application_Dial" target="_blank" rel="noopener noreferrer">Application: Dial()</a>: Behavior, options, DIALSTATUS handling for bridging calls.</li>
        <li><a href="https://en.wikipedia.org/wiki/Back-to-back_user_agent" target="_blank" rel="noopener noreferrer">Back-to-Back User Agent ‚Äî Wikipedia</a>: What a B2BUA is and how it differs from a SIP proxy.</li>
        <li><a href="https://www.rfc-editor.org/rfc/rfc3261" target="_blank" rel="noopener noreferrer">SIP (RFC 3261)</a>: Registrar role and SIP dialog basics (reference).</li>
        <li><a href="https://wiki.asterisk.org/wiki/display/AST/PJSIP+Configuration" target="_blank" rel="noopener noreferrer">PJSIP Configuration ‚Äî Asterisk</a>: Endpoint, AOR, auth, and transport objects used by the dialplan.</li>
      </ul>

      <h2>üé• Recommended Videos (Free & Short)</h2>
      <ul>
        <li>‚ÄúAsterisk Dialplan Basics‚Äù ‚Äî <a href="https://www.youtube.com/results?search_query=Asterisk+dialplan+basics" target="_blank" rel="noopener noreferrer">YouTube</a></li>
        <li>‚ÄúPJSIP Setup in Asterisk (Endpoints, AOR, Auth)‚Äù ‚Äî <a href="https://www.youtube.com/results?search_query=Asterisk+PJSIP+configuration+endpoints+aor+auth" target="_blank" rel="noopener noreferrer">YouTube</a></li>
        <li>‚ÄúB2BUA vs Proxy (SIP Architecture)‚Äù ‚Äî <a href="https://www.youtube.com/results?search_query=B2BUA+vs+SIP+proxy" target="_blank" rel="noopener noreferrer">YouTube</a></li>
      </ul>

      <h2>Deliverable</h2>
      <ul>
        <li>Files: <code>day5_dialplan_snippet.conf</code> (your internal/outbound example) and optional <code>day5_call_flow.png</code> (bridge diagram)</li>
        <li>Notes: 3 bullets on how your dialplan routes internal vs outbound calls and how failures are handled (e.g., <code>DIALSTATUS</code>, backup trunk)</li>
        <li>Goal: Demonstrate a minimal, safe routing logic with clear patterns and failovers.</li>
      </ul>

      <hr />

      <div class="quiz-controls">
        <button id="start-quiz" type="button">Start Quiz</button>
      </div>

      <h2 id="appendix-deep-dives">Appendix ‚Äî Deep Dives</h2>

      <h3>Deep Dive: Asterisk Dialplan Pattern Matching</h3>
      <ul>
        <li><code>_X</code> matches a digit; <code>.</code> matches one or more digits; character classes constrain sets.</li>
        <li>Use separate contexts for internal vs outbound; include contexts to compose routing.</li>
        <li>References: <a href="https://wiki.asterisk.org/wiki/display/AST/Dialplan" target="_blank" rel="noopener noreferrer">Dialplan</a>, <a href="https://wiki.asterisk.org/wiki/display/AST/Pattern+Matching" target="_blank" rel="noopener noreferrer">Pattern Matching</a></li>
      </ul>

      <h3>Deep Dive: PJSIP Object Model (endpoint, aor, auth, transport)</h3>
      <ul>
        <li><code>endpoint</code>: media/signaling; <code>aor</code>: contacts; <code>auth</code>: credentials; <code>transport</code>: IP/port/TLS.</li>
        <li>NAT helpers: <code>rewrite_contact</code>, <code>force_rport</code>, <code>rtp_symmetric</code>.</li>
        <li>References: <a href="https://wiki.asterisk.org/wiki/display/AST/PJSIP+Configuration" target="_blank" rel="noopener noreferrer">PJSIP Configuration</a></li>
      </ul>

      <h3>Deep Dive: Bridging and DIALSTATUS Handling</h3>
      <ul>
        <li><code>Dial()</code> returns statuses (BUSY, CONGESTION, NOANSWER, CHANUNAVAIL); implement fallbacks.</li>
        <li>References: <a href="https://wiki.asterisk.org/wiki/display/AST/Application_Dial" target="_blank" rel="noopener noreferrer">Application: Dial()</a></li>
      </ul>
      <div id="quiz" hidden>
        <h2>‚úÖ Quiz ‚Äî Day 5 (10 Questions + Answers)</h2>
        <ol>
          <li>What does a registrar store after a REGISTER request?
            <ul><li>Answer: The binding of a user to one or more Contact URIs (locations).</li></ul>
          </li>
          <li>Why is a PBX often called a B2BUA?
            <ul><li>Answer: It creates and manages two separate call legs and bridges them.</li></ul>
          </li>
          <li>What is a dialplan?
            <ul><li>Answer: A ruleset defining how calls are routed based on patterns/context.</li></ul>
          </li>
          <li>In the Asterisk example, what does <code>_9X.</code> mean?
            <ul><li>Answer: Pattern: numbers starting with 9, followed by one digit and any digits.</li></ul>
          </li>
          <li>What does <code>${EXTEN:1}</code> do in the example?
            <ul><li>Answer: Strips the leading 9 from the dialed extension.</li></ul>
          </li>
          <li>Name one reason to add safeguards in outbound routing.
            <ul><li>Answer: Prevent accidental international calls; limit by time/caller; whitelist.</li></ul>
          </li>
          <li>Where do endpoint, AOR, and auth objects live for PJSIP in Asterisk?
            <ul><li>Answer: In <code>pjsip.conf</code> (referenced by the dialplan).</li></ul>
          </li>
          <li>Which application bridges calls in the example dialplan?
            <ul><li>Answer: <code>Dial()</code>.</li></ul>
          </li>
          <li>How can failures be detected in Asterisk call bridging?
            <ul><li>Answer: Using <code>DIALSTATUS</code> and handling failover logic.</li></ul>
          </li>
          <li>Give two items typically found in an internal context.
            <ul><li>Answer: Extension-to-endpoint mappings (e.g., 1000/1001), local feature codes.</li></ul>
          </li>
        </ol>
      </div>

      <style>
      .quiz-modal[hidden]{display:none}
      .quiz-modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:999}
      .quiz-modal .overlay{position:absolute;inset:0;background:rgba(0,0,0,.55)}
      .quiz-modal .dialog{position:relative;background:var(--panel);border:1px solid #2a323c;border-radius:12px;max-width:640px;width:92%;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.6)}
      .quiz-modal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
      .quiz-modal header h3{margin:0}
      .quiz-modal .flashcard{background:#0f1318;border:1px solid #2a323c;border-radius:10px;padding:16px;min-height:140px}
      .quiz-modal .label{color:var(--muted);font-size:.9rem;margin-bottom:6px}
      .quiz-modal .text{white-space:pre-wrap}
      .quiz-modal .note{margin-top:10px;width:100%;min-height:80px;background:#0f1318;border:1px solid #2a323c;border-radius:8px;color:var(--text);padding:8px}
      .quiz-modal footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
      .quiz-modal button{background:var(--card);border:1px solid #2a323c;border-radius:10px;padding:8px 12px;color:var(--text)}
      </style>

      <div id="quiz-modal" class="quiz-modal" hidden>
        <div class="overlay" data-close="1"></div>
        <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="quiz-title">
          <header>
            <h3 id="quiz-title">Day 5 ‚Äî Quiz</h3>
            <button id="quiz-close" type="button" aria-label="Close">‚úï</button>
          </header>
          <div class="flashcard">
            <div id="flashcard-label" class="label">Question</div>
            <div id="flashcard-text" class="text"></div>
          </div>
          <textarea id="quiz-note" class="note" placeholder="Optional: jot your answer..."></textarea>
          <footer>
            <button id="quiz-back" type="button">Back</button>
            <button id="quiz-next" type="button">Next</button>
          </footer>
        </div>
      </div>

      <script>
      (function(){
        var quizContainer = document.getElementById('quiz');
        var startBtn = document.getElementById('start-quiz');
        var modal = document.getElementById('quiz-modal');
        var closeBtn = document.getElementById('quiz-close');
        var nextBtn = document.getElementById('quiz-next');
        var backBtn = document.getElementById('quiz-back');
        var labelEl = document.getElementById('flashcard-label');
        var textEl = document.getElementById('flashcard-text');
        var noteEl = document.getElementById('quiz-note');

        if(!quizContainer) return;

        var qa = [];
        var items = quizContainer.querySelectorAll('ol > li');
        items.forEach(function(li){
          var q = '';
          li.childNodes.forEach(function(node){ if(node.nodeType === Node.TEXT_NODE){ q += node.textContent; } });
          q = (q||'').trim().replace(/^\d+\)\s*/, '');
          var aEl = li.querySelector('ul li');
          var a = aEl ? aEl.textContent.replace(/^Answer:\s*/,'').trim() : '';
          if(q){ qa.push({q:q, a:a}); }
        });

        var idx = 0; var showingAnswer = false; var notes = qa.map(function(){return '';});
        function render(){
          if(!qa.length) return;
          var item = qa[idx];
          if(showingAnswer){ labelEl.textContent = 'Answer'; textEl.textContent = item.a || '(No answer provided)'; }
          else { labelEl.textContent = 'Question'; textEl.textContent = item.q; }
          if(noteEl){ noteEl.value = notes[idx] || ''; }
        }
        function openModal(){ idx=0; showingAnswer=false; render(); modal.removeAttribute('hidden'); }
        function closeModal(){ if(noteEl){ notes[idx]=noteEl.value; } modal.setAttribute('hidden',''); }
        function next(){ if(!qa.length) return; if(noteEl){ notes[idx]=noteEl.value; }
          if(!showingAnswer){ showingAnswer=true; render(); } else { showingAnswer=false; idx=(idx+1)%qa.length; render(); } }
        function back(){ if(!qa.length) return; if(noteEl){ notes[idx]=noteEl.value; }
          if(showingAnswer){ showingAnswer=false; render(); } else { idx=(idx-1+qa.length)%qa.length; showingAnswer=false; render(); } }
        if(startBtn) startBtn.addEventListener('click', openModal);
        if(closeBtn) closeBtn.addEventListener('click', closeModal);
        if(nextBtn) nextBtn.addEventListener('click', next);
        if(backBtn) backBtn.addEventListener('click', back);
        modal.addEventListener('click', function(e){ if(e.target && e.target.getAttribute('data-close')) closeModal(); });
        document.addEventListener('keydown', function(e){ if(!modal.hasAttribute('hidden') && e.key==='Escape') closeModal(); });
      })();
      </script>
    </section>
    <footer>
      <nav class="nav-top">
        <a href="./day-04.html">‚Üê Previous</a>
        <a href="./index.html">Back to Week 1</a>
        <a href="./day-06.html">Next ‚Üí</a>
      </nav>
    </footer>
  </main>
</body>
</html>

